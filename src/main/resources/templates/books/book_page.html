<!doctype html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      data-theme="light">

<head th:replace="~{fragments :: header_files(${book.name})}"></head>
<body>
<div th:replace="~{fragments :: navbar}"></div>

<div class="p-5 flex flex-col gap-20 max-w-screen-2xl mx-auto">

    <div class="flex flex-row gap-10">

        <div class="embla flex-1">
            <div class="embla__viewport">
                <div class="embla__container">
                    <div class="embla__slide">
                        <img th:src="@{${book.mainImageUrl}}" class="w-[300px] h-[300px] object-contain mx-auto">
                    </div>
                    <div class="embla__slide" th:each="image: ${book.bookImages}">
                        <img th:src="${image.url}" class="w-[300px] h-[300px] object-contain mx-auto">
                    </div>
                </div>
            </div>
            <div class="embla__controls">
                <div class="embla__buttons">
                    <button class="embla__button embla__button--prev" type="button">
                        <i class="fa-solid fa-angle-left"></i>
                    </button>

                    <button class="embla__button embla__button--next" type="button">
                        <i class="fa-solid fa-angle-right"></i>
                    </button>
                </div>

                <div class="embla__dots"></div>
            </div>
        </div>

        <div class="flex-1 flex flex-col gap-5">
            <h1 class="text-3xl font-bold" th:text="${book.name}"></h1>
            <div class="prose prose-ul:list-disc prose-ol:list-decimal" th:utext="${book.shortDescription}"></div>

            <p>
                <span class="font-semibold">Số hàng còn lại: </span><span th:text="${book.quantity}"></span>
            </p>

            <div class="flex flex-row gap-3 items-center">
                <p class="font-bold text-2xl text-red-600"
                   th:text="${#numbers.formatDecimal(book.price - book.price * (book.discountPercent / 100),0,'COMMA',1,'POINT') + '₫'}">
                </p>
                <p class="line-through"
                   th:text="${#numbers.formatDecimal(book.price,0,'COMMA',1,'POINT') + '₫'}"></p>
                <span class="badge badge-primary"
                      th:text="${'-' + book.discountPercent + '%'}"></span>
            </div>

            <th:block th:if="${book.enabled}">

                <button th:if="${book.quantity <= 0}" class="btn">Hết hàng</button>

                <a th:if="${book.quantity > 0}" sec:authorize="!isAuthenticated()" th:href="@{/login}" class="btn">Vui
                    lòng đăng nhập để mua</a>

                <form th:action="@{/cart/add}"
                      th:method="post"
                      th:if="${book.quantity > 0}"
                      sec:authorize="hasAuthority('Khách hàng')"
                      id="cart">
                    <input type="hidden" name="bookId" th:value="${book.id}">
                    <p class="mb-2 text-sm">Số lượng <span class="text-error">*</span></p>
                    <div class="flex flex-row items-center gap-2">
                        <button type="button" class="btn btn-ghost" id="btn-decrease">-</button>
                        <input type="number"
                               min="1"
                               th:max="${book.quantity}"
                               value="1"
                               placeholder="Số lượng"
                               required
                               onkeydown="return false;"
                               class="input input-bordered max-w-[100px]"
                               name="quantity"/>
                        <button type="button" class="btn btn-ghost" id="btn-increase">+</button>
                    </div>
                </form>

                <button th:if="${book.quantity > 0}"
                        sec:authorize="hasAuthority('Khách hàng')"
                        form="cart"
                        class="btn btn-primary">
                    Thêm vào giỏ hàng
                </button>

            </th:block>

            <button th:if="${!book.enabled}" class="btn">Ngừng kinh doanh</button>

        </div>

    </div>

    <div class="flex flex-row gap-10">

        <div th:utext="${book.fullDescription}"
             class="flex-1 grow-[3] prose prose-ul:list-disc prose-ol:list-decimal"></div>

        <div class="overflow-x-auto flex-1 grow-[2]">
            <table class="table table-zebra">
                <thead>
                <tr>
                    <th colspan="2" class="font-semibold text-xl text-center">Thông tin sản phẩm</th>
                </tr>
                </thead>
                <tbody>
                <tr>
                    <th>Nhà xuất bản</th>
                    <td>
                        <a class="text-primary" th:href="@{${'/book/search?publisherId=' + book.publisher.id}}"
                           th:text="${book.publisher.name}">
                        </a>
                    </td>
                </tr>
                <tr>
                    <th>Thể loại</th>
                    <td>
                        <ul class="list-disc text-primary">
                            <li th:each="category : ${book.categories}">
                                <a th:href="@{${'/book/search?categoryId=' + category.id}}"
                                   th:text="${category.name}"></a>
                            </li>
                        </ul>
                    </td>
                </tr>
                <tr>
                    <th>Tác giả</th>
                    <td>
                        <ul class="list-disc text-primary">
                            <li th:each="author : ${book.bookAuthors}">
                                <a th:href="@{${'/book/search?keyword=' + author.authorName}}"
                                   th:text="${author.authorName}"></a>
                            </li>
                        </ul>
                    </td>
                </tr>
                <tr th:each="spec : ${book.bookSpecs}">
                    <th th:text="${spec.name}"></th>
                    <td th:text="${spec.value}"></td>
                </tr>
                </tbody>
            </table>
        </div>

    </div>

    <div class="hidden recommend-section">
        <h2 class="font-semibold text-2xl text-center mb-5">Đề xuất cho bạn</h2>
        <div class="grid grid-cols-auto-fill gap-4 recommend"></div>
    </div>

    <div class="hidden recommend-similar-section">
        <h2 class="font-semibold text-2xl text-center mb-5">Sản phẩm tương tự</h2>
        <div class="grid grid-cols-auto-fill gap-4 recommend-similar"></div>
    </div>

</div>

<script type="module" th:inline="javascript">
    import {addPrevNextBtnsClickHandlers} from "/assets/js/embla/arrowBtn.js";
    import {addDotBtnsAndClickHandlers} from "/assets/js/embla/dotBtn.js";

    const OPTIONS = {loop: true}

    const emblaNode = document.querySelector('.embla')
    const viewportNode = emblaNode.querySelector('.embla__viewport')
    const prevBtnNode = emblaNode.querySelector('.embla__button--prev')
    const nextBtnNode = emblaNode.querySelector('.embla__button--next')
    const dotsNode = emblaNode.querySelector('.embla__dots')

    const emblaApi = EmblaCarousel(viewportNode, OPTIONS)

    const removePrevNextBtnsClickHandlers = addPrevNextBtnsClickHandlers(
        emblaApi,
        prevBtnNode,
        nextBtnNode
    )
    const removeDotBtnsAndClickHandlers = addDotBtnsAndClickHandlers(
        emblaApi,
        dotsNode
    )

    emblaApi.on('destroy', removePrevNextBtnsClickHandlers)
    emblaApi.on('destroy', removeDotBtnsAndClickHandlers)

    const btnIncrease = document.getElementById('btn-increase');
    const btnDecrease = document.getElementById('btn-decrease');
    const maxQuantity = parseInt(document.querySelector('input[name="quantity"]')?.max);

    btnIncrease?.addEventListener('click', () => {
        const quantity = document.querySelector('input[name="quantity"]');
        if (parseInt(quantity.value) >= maxQuantity) {
            return;
        }
        quantity.value = parseInt(quantity.value) + 1;
    });

    btnDecrease?.addEventListener('click', () => {
        const quantity = document.querySelector('input[name="quantity"]');
        if (parseInt(quantity.value) > 1) {
            quantity.value = parseInt(quantity.value) - 1;
        }
    });

    async function recommendItems() {
        const recommenderUrl = "http://localhost:8000";
        const csrfToken = document.head.querySelector("[name=_csrf]").content;
        let userId = /*[[${userId}]]*/ null;

        if (userId === null) {
            userId = "-1";
        }

        let res = await fetch(`${recommenderUrl}/recommend?n=10&user_id=${userId}`);
        let data = await res.json();
        const itemIds = data[userId]

        res = await fetch(`${contextPath}api/book/get-by-ids`, {
            method: "POST",
            credentials: "same-origin",
            headers: {
                "X-CSRF-Token": csrfToken,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(itemIds)
        });

        data = await res.json();

        const recommendSection = document.querySelectorAll(".recommend-section");
        const recommendDivs = document.querySelectorAll(".recommend")

        const priceFormatter = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND',
            minimumFractionDigits: 1,
            maximumFractionDigits: 1,
        })

        data.forEach(book => {
            const card = document.createElement("a");
            card.href = `${contextPath}book/${book.slug}`;
            card.className = "card card-compact w-full bg-base-100 shadow-lg hover:shadow-2xl hover:cursor-pointer";
            card.innerHTML = `
            <figure>
                <img src="${contextPath}books/${book.id}/${book.mainImage}" class="w-full h-[200px] object-contain"/>
            </figure>
            <div class="card-body flex flex-col justify-between tooltip" data-tip="${book.name}">
                <h2 class="card-title text-sm break-words overflow-2-line">${book.name}</h2>
                <div class="flex flex-col gap-3">
                    <p>
                        <span class="line-through" >${priceFormatter.format(book.price)}</span>
                        <span class="badge badge-primary">-${book.discountPercent}%</span>
                    </p>
                    <p class="font-semibold text-lg btn btn-primary">₫${priceFormatter.format(book.price - book.price * (book.discountPercent / 100))} </p>
                </div>
            </div>`

            recommendDivs.forEach(div => {
                div.appendChild(card);
            })
        });

        recommendSection.forEach(section => {
            section.classList.remove("hidden");
        })
    }

    async function recommendSimilar() {

        const recommenderUrl = "http://localhost:8000";
        const csrfToken = document.head.querySelector("[name=_csrf]").content;
        const itemId = /*[[${book.id}]]*/ null;
        let userId = /*[[${userId}]]*/ null;

        if (userId === null) {
            userId = "-1";
        }

        let res = await fetch(`${recommenderUrl}/recommend-knn?n=6&item_id=${itemId}`);
        let data = await res.json();

        res = await fetch(`${contextPath}api/book/get-by-ids`, {
            method: "POST",
            credentials: "same-origin",
            headers: {
                "X-CSRF-Token": csrfToken,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        });

        data = await res.json();

        const recommendSection = document.querySelectorAll(".recommend-similar-section");
        const recommendDivs = document.querySelectorAll(".recommend-similar")

        const priceFormatter = new Intl.NumberFormat('vi-VN', {
            style: 'currency',
            currency: 'VND',
            minimumFractionDigits: 1,
            maximumFractionDigits: 1,
        })

        data.forEach(book => {
            const card = document.createElement("a");
            card.href = `${contextPath}book/${book.slug}`;
            card.className = "card card-compact w-full bg-base-100 shadow-lg hover:shadow-2xl hover:cursor-pointer";
            card.innerHTML = `
            <figure>
                <img src="${contextPath}books/${book.id}/${book.mainImage}" class="w-full h-[200px] object-contain"/>
            </figure>
            <div class="card-body flex flex-col justify-between tooltip" data-tip="${book.name}">
                <h2 class="card-title text-sm break-words overflow-2-line">${book.name}</h2>
                <div class="flex flex-col gap-3">
                    <p>
                        <span class="line-through" >${priceFormatter.format(book.price)}</span>
                        <span class="badge badge-primary">-${book.discountPercent}%</span>
                    </p>
                    <p class="font-semibold text-lg btn btn-primary">₫${priceFormatter.format(book.price - book.price * (book.discountPercent / 100))} </p>
                </div>
            </div>`

            recommendDivs.forEach(div => {
                div.appendChild(card);
            })
        });

        recommendSection.forEach(section => {
            section.classList.remove("hidden");
        })
    }

    recommendItems()
    // recommendSimilar()

</script>

</body>
</html>
