<!doctype html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      data-theme="light"
>
<head th:replace="~{fragments :: header_files('Nhà Sách Trực Tuyến Hàng Đầu Việt Nam')}"></head>
<body>
<div th:replace="~{fragments :: navbar}"></div>

<div class="max-w-7xl mx-auto p-5">
    <div th:each="section : ${sections}" class="mt-6 mb-14">

        <th:block th:if="${section.type.name() == 'BOOK'}">
            <h2 th:text="${section.title}" class="font-semibold text-2xl text-center mb-5"></h2>
            <th:block th:replace="~{homepage/book_section :: book_section}"></th:block>
        </th:block>

        <th:block th:if="${section.type.name() == 'CATEGORY'}">
            <h2 th:text="${section.title}" class="font-semibold text-2xl text-center mb-5"></h2>
            <th:block th:replace="~{homepage/category_section :: category_section}"></th:block>
        </th:block>

        <th:block th:if="${section.type.name() == 'PUBLISHER'}">
            <h2 th:text="${section.title}" class="font-semibold text-2xl text-center mb-5"></h2>
            <th:block th:replace="~{homepage/publisher_section :: publisher_section}"></th:block>
        </th:block>

        <th:block th:if="${section.type.name() == 'RECOMMENDATION'}">
            <div class="hidden recommend-section">
                <h2 th:text="${section.title}" class="font-semibold text-2xl text-center mb-5"></h2>
                <div class="grid grid-cols-auto-fill gap-4 recommend"></div>
            </div>
        </th:block>
    </div>

</div>
<script type="module" th:inline="javascript">
    const recommenderUrl = "http://localhost:8000";
    const csrfToken = document.head.querySelector("[name=_csrf]").content;
    let userId = /*[[${userId}]]*/ null;

    if (userId === null) {
        userId = "-1";
    }

    let res = await fetch(`${recommenderUrl}/recommend?n=10&user_id=${userId}`);
    let data = await res.json();
    const itemIds = data[userId]

    res = await fetch(`${contextPath}api/book/get-by-ids`, {
        method: "POST",
        credentials: "same-origin",
        headers: {
            "X-CSRF-Token": csrfToken,
            "Content-Type": "application/json"
        },
        body: JSON.stringify(itemIds)
    });

    data = await res.json();

    const recommendSection = document.querySelectorAll(".recommend-section");
    const recommendDivs = document.querySelectorAll(".recommend")

    const priceFormatter = new Intl.NumberFormat('vi-VN', {
        style: 'currency',
        currency: 'VND',
        minimumFractionDigits: 1,
        maximumFractionDigits: 1,
    })

    data.forEach(book => {
        const card = document.createElement("a");
        card.href = `${contextPath}book/${book.slug}`;
        card.className = "card card-compact w-full bg-base-100 shadow-lg hover:shadow-2xl hover:cursor-pointer";
        card.innerHTML = `
            <figure>
                <img src="${contextPath}books/${book.id}/${book.mainImage}" class="w-full h-[200px] object-contain"/>
            </figure>
            <div class="card-body flex flex-col justify-between tooltip" data-tip="${book.name}">
                <h2 class="card-title text-sm break-words overflow-2-line">${book.name}</h2>
                <div class="flex flex-col gap-3">
                    <p>
                        <span class="line-through" >${priceFormatter.format(book.price)}</span>
                        <span class="badge badge-primary">-${book.discountPercent}%</span>
                    </p>
                    <p class="font-semibold text-lg btn btn-primary">₫${priceFormatter.format(book.price - book.price * (book.discountPercent / 100))} </p>
                </div>
            </div>`

        recommendDivs.forEach(div => {
            div.appendChild(card);
        })
    });

    recommendSection.forEach(section => {
        section.classList.remove("hidden");
    })

</script>
</body>
</html>